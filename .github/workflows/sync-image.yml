name: Sync Multiple Images to CNB

on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

jobs:
  sync-images:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # å³ä½¿å…¶ä¸­ä¸€ä¸ªå¤±è´¥ï¼Œä¹Ÿç»§ç»­æ‰§è¡Œå…¶ä»–çš„åŒæ­¥ä»»åŠ¡
      matrix:
        include:
          # --- è¿™é‡Œé…ç½®ä½ éœ€è¦åŒæ­¥çš„æ‰€æœ‰é•œåƒåˆ—è¡¨ ---

          # 1. åŒååˆ¶å“ç¤ºä¾‹ (Mihomo)
          - source: metacubex/mihomo:latest
            target: docker.cnb.cool/youvigo/base/mihomo:latest

          # 2. ä½ çš„å…¶ä»–å¼€å‘ç¯å¢ƒ/åŸºç¡€é•œåƒç¤ºä¾‹
          - source: mysql:lts
            target: docker.cnb.cool/youvigo/base/mysql:lts

          - source: nginx:stable-alpine-perl
            target: docker.cnb.cool/youvigo/base/nginx:stable-alpine-perl

          # ä½ å¯ä»¥åœ¨è¿™é‡ŒæŒ‰ç…§ä¸Šé¢çš„æ ¼å¼æ— é™æ·»åŠ ...

    steps:
      - name: Sync Image using Skopeo
        run: |
          echo "ğŸš€ å¼€å§‹åŒæ­¥: ${{ matrix.source }} -> ${{ matrix.target }}"

          # GitHub å®˜æ–¹çš„ ubuntu-latest å·²ç»é¢„è£…äº† skopeo
          # ä½¿ç”¨ docker:// å‰ç¼€å‘Šè¯‰ skopeo è¿™æ˜¯ä¸€ä¸ªæ ‡å‡†çš„å®¹å™¨é•œåƒä»“åº“
          skopeo copy --all \
            --dest-creds="cnb:${{ secrets.CNB_TOKEN }}" \
            docker://${{ matrix.source }} \
            docker://${{ matrix.target }}

          echo "âœ… åŒæ­¥å®Œæˆ!"
